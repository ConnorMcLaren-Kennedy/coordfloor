# CoordFloor — Coordination Floor Analysis

This repository contains the analysis code for estimating a coordination floor: the slowest running speed at which muscle-synergy coordination (NMF modules) remains within participant-specific reliability bounds defined at a reference speed.

## Documentation

| Document | Description |
|----------|-------------|
| **This README** | Setup and running instructions |
| **[TECHNICAL.md](TECHNICAL.md)** | Implementation details (seeding, parameters, algorithms) |
| **[scripts/data/README.md](scripts/data/README.md)** | Data download and placement instructions |

---

## Quick Start

```bash
# 1. Create environment
conda env create -f environment.yml
conda activate coordfloor

# 2. Download data (see scripts/data/README.md)

# 3. Preprocess (per subject)
for s in $(seq 1 19); do
  python scripts/01_preprocess.py --params params/base.yaml --subject "$s"
done

# 4. Run core pipeline
python scripts/02a_nmf_baseline.py
python scripts/02b_nmf_rankselect.py
python scripts/02c_nmf_stability.py
python scripts/03_compute_fidelity.py --rel7 .
python scripts/04_compute_reliability.py
python scripts/05_compute_surrogates.py --n 1000
python scripts/06_compute_spatial_temporal_metrics.py
python scripts/07_detect_floor.py
```

**Note (submission package vs generated outputs):** The `outputs/` folder in this submission package contains precomputed artefacts used to reproduce the thesis results without distributing raw EMG/GRF data. When running the full pipeline with the required public datasets, additional outputs listed below will be generated into `outputs/`.

---

## Data

Two public datasets are required:

**Van Hooren (primary)** — EMG + GRF at multiple speeds
> van Hooren, B., & Meijer, K. (2024). Dataset of running kinematics, kinetics and muscle activation at different speeds, surface gradients, cadences and with forward trunk lean. *Data in Brief*, 54, 110312. [DOI: 10.1016/j.dib.2024.110312](https://doi.org/10.1016/j.dib.2024.110312)

**Santuz (validation)** — EMG at preferred speed
> Santuz, A., et al. (2018). Modular Control of Human Movement During Running: An Open Access Data Set. *Frontiers in Physiology*, 9, 1509. [DOI: 10.3389/fphys.2018.01509](https://doi.org/10.3389/fphys.2018.01509)

See [scripts/data/README.md](scripts/data/README.md) for download and placement instructions.

### Expected Layout

```
data/
├── raw/vanhooren/           # Downloaded C3D files + Excel mapping
└── processed/               # Generated by preprocessing
    ├── vanhooren/
    └── santuz/vanhooren_like/
```

---

## Pipeline Overview

### 1. Preprocessing

`01_preprocess.py` processes raw EMG and GRF data into stride-normalised matrices.

```bash
python scripts/01_preprocess.py --params params/base.yaml --subject 1
```

**Outputs**: `data/processed/vanhooren/Sub_XX/level_strideparity/*_matched.npz`

### 2. NMF Extraction and Rank Selection

```bash
python scripts/02a_nmf_baseline.py    # Extract synergies for k=2..7
python scripts/02b_nmf_rankselect.py  # Select k via VAF thresholds
python scripts/02c_nmf_stability.py   # Bootstrap stability screening
```

**Outputs**: `outputs/nmf_baseline/`, `outputs/chosen_k.csv`, `outputs/stability_summary.csv`

### 3. Coordination Fidelity

```bash
python scripts/03_compute_fidelity.py --rel7 .
```

**Outputs**: `outputs/coordination_fidelity.csv`

### 4. Reliability Envelope

```bash
python scripts/04_compute_reliability.py
```

**Outputs**: `outputs/reliability_envelope.csv`, `outputs/reliability_distributions/`

### 5. Surrogate Baseline

```bash
python scripts/05_compute_surrogates.py --n 1000
```

**Outputs**: `outputs/surrogate_baseline.csv`

### 6. Additional Metrics

```bash
python scripts/06_compute_spatial_temporal_metrics.py
```

**Outputs**: `outputs/spatial_temporal_metrics.csv`

### 7. Floor Detection

```bash
python scripts/07_detect_floor.py
```

**Outputs**: `outputs/coordination_floors.csv`, `outputs/coordination_floor_gates_by_speed.csv`

### 8. Secondary Analyses (Optional)

```bash
# Changepoint cross-check
python scripts/08_changepoint_analysis.py

# Sensitivity analyses
python scripts/09_sensitivity_analyses.py

# Santuz validation
python scripts/10_santuz_validation.py

# Reorganisation profile
python scripts/03b_full_pairwise_fidelity.py --rel7 .
python scripts/12_within_speed_reliability.py --rel7 . --dataset vanhooren --n_boot 100
python scripts/11_reorganization_profile.py
```

---

## Analysis Registry

The pipeline is driven by `outputs/unified_registry.csv`, which defines:
- Which subject/speed conditions exist
- Where processed files are located
- Which muscles are used per subject

Modify this file to change which conditions are analysed.

---

## Path Configuration

| Variable | Purpose | Default |
|----------|---------|---------|
| `UPSTREAM_PATH` | Location of input `outputs/` directory | Script's parent `outputs/` |
| `DATA_PATH` | Location of `data/` directory | Script's parent `data/` |
| `--rel7` | Path to folder containing `outputs/stability_summary.csv` | Required for fidelity scripts |

For single-folder runs, defaults work without modification.

---

## Output Summary

These files are generated by the pipeline when run with the required datasets. They are not expected to be present in a clean submission package unless explicitly noted.

Key output files:

| File | Contents |
|------|----------|
| `coordination_floors.csv` | Primary and 7-gate floor estimates per subject |
| `reliability_envelope.csv` | Participant-specific reliability bounds |
| `coordination_fidelity.csv` | Cross-speed fidelity values |
| `surrogate_baseline.csv` | IAAFT null thresholds |
| `spatial_temporal_metrics.csv` | Cosine, DTW, principal angle metrics |
| `sensitivity_comparison.csv` | Variant agreement statistics |

---

## Reproducibility


All stochastic procedures use deterministic seeding.

### Integrity / checksum verification

This repository includes scripts to generate and verify a SHA-256 manifest for the current folder state.

```bash
# 1) Generate a manifest for this folder (CSV)
python scripts/create_master_manifest.py --root . --output manifest_sha256.csv

# 2) Verify every file against the manifest
python scripts/verify_checksums.py --manifest manifest_sha256.csv --base-dir .
```

See TECHNICAL.md for seeding schemes and exact parameters.
